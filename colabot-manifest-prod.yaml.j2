---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: colabot-prod-1
spec:
  replicas: 2
  selector:
    matchLabels:
      app: colabot-prod-1
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 1
  minReadySeconds: 5
  template:
    metadata:
      labels:
        app: colabot-prod-1
    spec:
      imagePullSecrets:
        - name: ghcr-login-secret
      containers:
        - image: ghcr.io/ciscops/colabot:main
          imagePullPolicy: Always
          name: colabot-prod-1
          ports:
            - containerPort: 3000
          securityContext:
            allowPrivilegeEscalation: false
            privileged: false
            readOnlyRootFilesystem: false
          env:
          - name: ACCESS_TOKEN
            valueFrom:
              secretKeyRef:
                name: colabot-prod-1-secret
                key: access_token
          - name: BOT_ID
            value: {{ BOT_ID_PROD }}
          - name: BOT_NAME
            value: {{ BOT_NAME_PROD }}
          - name: AUTHORIZED_ROOMS
            value: {{ AUTHORIZED_ROOMS_PROD }}
          - name: WEB_PORT
            value: '3000'
          - name: DIALOGUE_TIMEOUT
            value: '30'
          - name: PUBLIC_ADDRESS
            value: {{ PUBLIC_ADDRESS_PROD }}
          - name: SERVER_LIST
            value: {{ SERVER_LIST_PROD }}
          - name: CML_USERNAME
            value: {{ CML_USERNAME }}
          - name: CML_PASSWORD
            valueFrom:
              secretKeyRef:
                name: colabot-prod-1-secret
                key: cml_password
          - name: SECRET
            valueFrom:
              secretKeyRef:
                name: colabot-prod-1-secret
                key: api_secret
          - name: MONGO_INITDB_ROOT_USERNAME
            value: {{ MONGO_INITDB_ROOT_USERNAME }}
          - name: MONGO_INITDB_ROOT_PASSWORD
            valueFrom:
              secretKeyRef:
                name: colabot-prod-1-secret
                key: mongo_initb_root_password
          - name: MONGO_SERVER
            value: {{ MONGO_SERVER_PROD }}
          - name: MONGO_PORT
            value: '27017'
          - name: MONGO_DB
            value: 'colabot'
          - name: MONGO_COLLECTIONS
            value: 'labinfo'
          - name: MONGO_DB_ACTIVITY
            value: colabot_dialogue_db
          - name: MONGO_COLLECTIONS_ACTIVITY
            value: colabot_dialogue_collection
          - name: AWX_SERVER
            value: {{ AWX_SERVER }}
          - name: AWX_USERNAME
            value: {{ AWX_USERNAME }}
          - name: AWX_PASSWORD
            valueFrom:
              secretKeyRef:
                name: colabot-prod-1-secret
                key: awx_password
          - name: NLP_SERVER
            value: {{ NLP_SERVER_PROD }}
          - name: NLP_SECRET
            valueFrom:
              secretKeyRef:
                name: colabot-prod-1-secret
                key: nlp_secret
          - name: VCENTER_SERVER
            value: {{ VCENTER_SERVER }}
          - name: ADMINISTRATORS
            value: {{ ADMINISTRATORS_PROD }}
          - name: AWS_ACCESS_KEY_ID
            value: {{ AWS_ACCESS_KEY_ID }}
          - name: AWS_REGION
            value: 'us-east-1'
          - name: AWS_SECRET_ACCESS_KEY
            valueFrom:
              secretKeyRef:
                name: colabot-prod-1-secret
                key: aws_password
          - name: COLABOT_SECRET
            value: {{ COLABOT_SECRET }}      
          - name: AWS_DYNAMO_TABLE
            value: {{ DYNAMO_TABLE_PROD }}  
          - name: NETBOX_URL
            value: {{ NETBOX_URL_PROD }}  
          - name: NETBOX_TOKEN
            value: {{ NETBOX_TOKEN_PROD }}

---

apiVersion: v1
kind: Service
metadata:
  name: colabot-prod-1-svc
spec:
  type: NodePort
  ports:
  - port: 80
    protocol: TCP
    targetPort: 3000
    name: http
  selector:
    app: colabot-prod-1
